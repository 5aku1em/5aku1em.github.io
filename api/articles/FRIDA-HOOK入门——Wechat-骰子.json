{"title":"FRIDA HOOK入门——Wechat 骰子","slug":"FRIDA-HOOK入门——Wechat-骰子","date":"2020-07-25T01:48:12.000Z","updated":"2020-07-25T07:40:59.729Z","comments":true,"excerpt":"","content":"<p>frida入门学习。最开始接触过的安卓相关的hook还是xposed，但也没有实际的开发过，大多时候只是在使用，偶尔解包出来看看java层的实现原理。这次有机会初步地探究一下利用frida对安卓进行hook。</p>\n<p>网上也找到的相关的code，但都比较久远了，微信每次更新应该都是打了混淆的，导致原本的代码无法直接使用，这里我选用当前最新的7.0.174版本7.0.174进行测试（weixin7017android1720）。</p>\n<p>经过测试在x86模拟器和arm64的pixel上都能成功实现hook。</p>\n<p>连接上adb和frida后，还是利用logcat先收集一下信息</p>\n<p><img src=\"C:%5CUsers%5Chp%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20200725100341834.png\" alt=\"image-20200725100341834\"></p>\n<p>动作稍微快一点，wechat生成的log文件还是比较大的。</p>\n<p>打开log.txt,根据已有的经验搜索一下</p>\n<p><img src=\"C:%5CUsers%5Chp%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20200725135745097.png\" alt=\"image-20200725135745097\"></p>\n<p><img src=\"C:%5CUsers%5Chp%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20200725135801355.png\" alt=\"image-20200725135801355\"></p>\n<p><img src=\"C:%5CUsers%5Chp%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20200725135819188.png\" alt=\"image-20200725135819188\"></p>\n<p><img src=\"C:%5CUsers%5Chp%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20200725135831747.png\" alt=\"image-20200725135831747\"></p>\n<p>找到的一些可疑的位置</p>\n<p>利用icodetools提取出apk中的jar，利用jdgui打开，</p>\n<p>根据com/tencent/mm/sdk/platform目录，找到可疑的class</p>\n<p><img src=\"C:%5CUsers%5Chp%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20200725152940756.png\" alt=\"image-20200725152940756\"></p>\n<p>对于骰子以及剪刀石头布，控制的随机函数返回值大概率是int，根据这个特点再进行搜索</p>\n<p><img src=\"C:%5CUsers%5Chp%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20200725153403628.png\" alt=\"image-20200725153403628\"></p>\n<p>扎到了调用了random函数的可疑函数，编写脚本经行尝试</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> frida</span><br><span class=\"line\"><span class=\"keyword\">import</span> sys</span><br><span class=\"line\">rdev = frida.get_remote_device()</span><br><span class=\"line\">session = rdev.attach(<span class=\"string\">\"com.tencent.mm\"</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">scr = <span class=\"string\">\"\"\"</span></span><br><span class=\"line\"><span class=\"string\">Java.perform(function () &#123;</span></span><br><span class=\"line\"><span class=\"string\">var bs = Java.use(\"com.tencent.mm.sdk.platformtools.bs\");</span></span><br><span class=\"line\"><span class=\"string\">send(typeof(ao));</span></span><br><span class=\"line\"><span class=\"string\">send(typeof(ao.jt));</span></span><br><span class=\"line\"><span class=\"string\">bs.jt.implementation = function()&#123;</span></span><br><span class=\"line\"><span class=\"string\">    var type = arguments[0];</span></span><br><span class=\"line\"><span class=\"string\">    send(\"type=\"+type);</span></span><br><span class=\"line\"><span class=\"string\">    if (type == 2)</span></span><br><span class=\"line\"><span class=\"string\">    &#123;</span></span><br><span class=\"line\"><span class=\"string\">    return this.a(type);</span></span><br><span class=\"line\"><span class=\"string\">    &#125;</span></span><br><span class=\"line\"><span class=\"string\">    else</span></span><br><span class=\"line\"><span class=\"string\">    &#123;</span></span><br><span class=\"line\"><span class=\"string\">    return 5;</span></span><br><span class=\"line\"><span class=\"string\">    &#125;</span></span><br><span class=\"line\"><span class=\"string\">&#125;;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">&#125;);</span></span><br><span class=\"line\"><span class=\"string\">\"\"\"</span></span><br><span class=\"line\"></span><br><span class=\"line\">script = session.create_script(scr)</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">on_message</span><span class=\"params\">(message ,data)</span>:</span></span><br><span class=\"line\">    print(message)</span><br><span class=\"line\">script.on(<span class=\"string\">\"message\"</span> , on_message)</span><br><span class=\"line\">script.load()</span><br><span class=\"line\">sys.stdin.read()</span><br></pre></td></tr></table></figure>\n\n<p>观察到hook成功</p>\n<p><img src=\"C:%5CUsers%5Chp%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20200725153820863.png\" alt=\"image-20200725153820863\"></p>\n<p>同理也可以hook掉剪刀石头布</p>\n<blockquote>\n<p>第一次用frida来hook，使用的功能也比较少，手法也很生疏，希望之后能够更加熟练地使用这个工具，在很多场合感觉这个工具会有相当出色地表现。</p>\n</blockquote>\n","categories":[],"tags":[{"name":"TX,FRIDA HOOK,jdGUI,logcat","path":"api/tags/TX,FRIDA HOOK,jdGUI,logcat.json"}]}